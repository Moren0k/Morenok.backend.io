# V1.0.0 â€” Technical Analysis

> **Date:** 2026-02-24  
> **Branch:** develop  
> **Status:** Stable â€” Feature-complete for initial public release.

---

## 1. High-Level Overview

Morenok.backend.io is a **multi-tenant SaaS portfolio backend** built on .NET 8 Minimal APIs. Each registered user owns an independent portfolio namespace identified by a unique `PortfolioSlug`. The system provides:

- Authenticated CRUD for portfolio projects with Cloudinary media assets.
- A public, rate-limited endpoint to fetch any user's published projects by slug.
- A technologies catalog shared across all tenants.
- JWT-based authentication with per-tenant ownership enforcement.

There is no frontend embedded in this repository. The API is designed to be consumed by an independent frontend application.

---

## 2. Architecture Map

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Backend.Api (HTTP Layer)                                         â”‚
â”‚  Endpoints: Auth, Me, Projects, Technologies, Portfolio         â”‚
â”‚  Middleware: GlobalExceptionMiddleware                           â”‚
â”‚  Config: Program.cs (DI, JWT, RateLimit, Kestrel limits)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚ depends on
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Backend.Application (Use Cases / Contracts)                      â”‚
â”‚  ProjectService, TechnologyService, AssetOrchestrator           â”‚
â”‚  IAuthService, IProjectRepository, ITechnologyRepository,        â”‚
â”‚  IAssetRepository, IUserRepository, IUnitOfWork                 â”‚
â”‚  DTOs, SlugHelper                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ depends on           â”‚ depends on
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Backend.Domain            â”‚  â”‚ Backend.Infrastructure           â”‚
â”‚  Entities: Project, Asset,â”‚  â”‚  AppDbContext (EF Core/Npgsql)  â”‚
â”‚  Technology, ProjectTech. â”‚  â”‚  Repositories (EF-backed)       â”‚
â”‚  Enums: ProjectStatus,    â”‚  â”‚  AuthService (JWT)              â”‚
â”‚  AssetProvider,           â”‚  â”‚  CloudinaryService              â”‚
â”‚  AssetResourceType        â”‚  â”‚  Identity.User (auth model)     â”‚
â”‚  BaseEntity               â”‚  â”‚  UnitOfWork                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Dependency direction:** Domain â† Application â† Infrastructure / Api  
Domain has zero external dependencies.

---

## 3. Data Model

### Tables

| Table | Primary Key | Key Constraints |
|-------|-------------|-----------------|
| `users` | `Id` (UUID) | `Email` UNIQUE, `PortfolioSlug` UNIQUE (max 64 chars) |
| `projects` | `Id` (UUID) | (`OwnerId`, `DisplayOrder`) UNIQUE; filtered UNIQUE on `OwnerId` WHERE `IsPinned = true` |
| `assets` | `Id` (UUID) | No unique constraint beyond PK |
| `technologies` | `Id` (UUID) | `Name` UNIQUE, `Slug` UNIQUE |
| `project_technologies` | (`ProjectId`, `TechnologyId`) | Composite PK |

### Key Indexes

```
users:
  - IX_users_Email (UNIQUE)
  - IX_users_PortfolioSlug (UNIQUE)

projects:
  - IX_projects_OwnerId_DisplayOrder (UNIQUE)
  - IX_projects_OwnerId WHERE IsPinned = true (UNIQUE filtered â€” one pinned per owner)
  - IX_projects_OwnerId_IsPinned_DisplayOrder (composite, sort optimization)

technologies:
  - IX_technologies_Slug (UNIQUE)
  - IX_technologies_Name (UNIQUE)
```

### Foreign Keys

| FK | From | To | On Delete |
|----|------|----|-----------|
| `CoverAssetId` | `projects` | `assets` | RESTRICT |
| `DemoVideoAssetId` | `projects` | `assets` | RESTRICT |
| `ProjectId` | `project_technologies` | `projects` | CASCADE |
| `TechnologyId` | `project_technologies` | `technologies` | RESTRICT |

### Enum Storage

- `ProjectStatus` â†’ stored as `string` (`Draft`, `Published`, `Archived`)
- `AssetProvider` â†’ stored as `string` (currently always `Cloudinary`)
- `AssetResourceType` â†’ stored as `string` (`Image`, `Video`)

### Timestamps

All entities implement `CreatedAt` / `UpdatedAt` (UTC) automatically via `AppDbContext.UpdateTimestamps()`, which intercepts `SaveChanges`/`SaveChangesAsync`.

### Migration State

> No EF Core migration files exist in the repository at v1.0.0. The schema must be applied via `dotnet ef database update` after generating a migration from current model state. The Render PostgreSQL database may already be ahead of the local migration history â€” verify before running migrations.

---

## 4. Auth Model

### Token Generation

| Claim | Value | Notes |
|-------|-------|-------|
| `sub` | User GUID | Standard JWT subject |
| `email` | User email | Standard JWT email claim |
| `owner_id` | User GUID | Custom claim used for all ownership enforcement |

- Algorithm: **HmacSha256** (symmetric)
- Expiry: **7 days** from issue
- Signing key: `Jwt__Key` env var (UTF-8 bytes)

### Security Boundaries

- **All admin endpoints** (`/api/projects/*`, `/api/technologies/*`, `/api/me`) are protected by `RequireAuthorization()`.
- `OwnerId` is **always** extracted from the `owner_id` JWT claim server-side â€” never from the request body or query string. Clients cannot impersonate other tenants.
- The public portfolio endpoint (`/api/portfolio/{slug}/projects`) has **no auth requirement** â€” it is intentionally public.

### Tenant Resolution

```
JWT â†’ owner_id claim â†’ Guid ownerId
All repository queries: WHERE OwnerId = @ownerId
```

There is no role system. Every authenticated user is the admin of their own tenant namespace.

### Slug Registration Flow

At `POST /api/auth/register`:
1. If `PortfolioSlug` is provided â†’ normalize it.
2. If omitted â†’ derive slug from the email local-part (before `@`), then normalize.
3. Verify uniqueness in `users.PortfolioSlug`. If collision â†’ `400 Bad Request`.
4. Persist user. Issue JWT immediately.

---

## 5. Asset Flow

### Upload (Create / Update Project)

```
Client                     API Endpoint             AssetOrchestrator         Cloudinary     DB
  â”‚â”€â”€ multipart/form-data â”€â–¶â”‚                        â”‚                         â”‚             â”‚
  â”‚                         â”‚â”€â”€ CreateAssetFromUpload â–¶â”‚                         â”‚             â”‚
  â”‚                         â”‚                        â”‚â”€â”€ Upload file â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚             â”‚
  â”‚                         â”‚                        â”‚â—€â”€ (publicId, url) â”€â”€â”€â”€â”€â”€â”€â”‚             â”‚
  â”‚                         â”‚                        â”‚â”€â”€ AddAsync(asset) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
  â”‚                         â”‚                        â”‚   (SaveChanges NOT called yet)            â”‚
  â”‚                         â”‚â”€â”€ CreateProjectAsync â”€â”€â–¶ProjectService            â”‚             â”‚
  â”‚                         â”‚                        â”‚â”€â”€ BeginTransaction â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
  â”‚                         â”‚                        â”‚â”€â”€ SaveChanges (Asset + Project) â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
  â”‚                         â”‚                        â”‚â”€â”€ Commit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
  â”‚â—€â”€â”€ 201 Created â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                        â”‚                         â”‚             â”‚
```

**Compensation on DB failure:**
- If `AddAsync(asset)` fails â†’ delete from Cloudinary immediately, throw.
- If `ProjectService.CreateProjectAsync` throws after asset upload â†’ endpoint catches, calls `DeleteAssetBothAsync` on both cover and demo video.

### Deletion (Delete Project)

```
1. Fetch project from DB (capture CoverAssetId, DemoVideoAssetId)
2. Begin transaction
3. Remove project_technologies
4. Delete project
5. NormalizeDisplayOrders
6. SaveChanges + Commit
7. Post-commit: DeleteAssetBothAsync(cover)
8. Post-commit: DeleteAssetBothAsync(demoVideo) [if present]
```

`DeleteAssetBothAsync`:
1. Fetch asset from DB.
2. Delete from DB + SaveChanges (commit DB-side first).
3. Delete from Cloudinary (best-effort; Cloudinary failure is swallowed â€” DB is already clean).

**DB-first deletion** ensures no dangling DB records even if Cloudinary deletion fails. A Cloudinary orphan may remain on failure, but this is logged (when a logger is attached).

### Asset Size Guardrails (Application Layer)

| Type | Limit |
|------|-------|
| Image | 10 MB |
| Video | 50 MB |

Kestrel and `FormOptions` accept up to **60 MB** per request.

### Cloudinary Folder Convention

Assets are stored under: `morenok/{ownerId}/{filename}`

---

## 6. Ordering Rules

### IsPinned / DisplayOrder Invariants (enforced at Domain level)

| State | `IsPinned` | `DisplayOrder` |
|-------|-----------|---------------|
| Pinned | `true` | `0` |
| Unpinned | `false` | `â‰¥ 1` |

A `DisplayOrder < 0` is rejected at construction time. A pinned project with `DisplayOrder != 0` is rejected.

### Service-Level Ordering Logic

**On Create:**
- If `IsPinned = true`:
  - New project gets `DisplayOrder = 0`.
  - Any existing pinned project is unpinned and placed at position `1`.
  - All unpinned projects are shifted up by 1.
- If `IsPinned = false`:
  - If `DisplayOrder` is null, out of range, or `< 1` â†’ auto-assign `maxOrder + 1`.
  - If valid `DisplayOrder` provided â†’ shift existing projects at that position upward.
- `NormalizeDisplayOrders` is called after every write to compact gaps.

**On Update:**
- Pinning â†’ unpin existing pinned project, shift others.
- Unpinning â†’ assign `maxOrder + 1` (or provided order if valid).
- Reorder (both unpinned) â†’ shift others, set new order.

**On Delete:**
- `NormalizeDisplayOrders` is called after commit to remove gaps.

---

## 7. Public Portfolio Endpoint

**Route:** `GET /api/portfolio/{portfolioSlug}/projects`

**Behavior:**
1. Normalize the incoming slug via `SlugHelper.NormalizeSlug`.
2. If empty after normalization â†’ `404`.
3. Look up `OwnerId` from `users.PortfolioSlug` (exact match on normalized slug).
4. If not found â†’ `404`.
5. Call `GetPublishedProjectsAsync(ownerId)` â†’ returns only `Status = Published` projects.
6. Bulk-fetch technologies and assets for all returned projects (no N+1).
7. Return project DTOs including `CoverUrl`, `DemoVideoUrl` (populated from `assets` table), and `Technologies` collection.

**Rate Limiting:**
- Policy: `portfolio` (fixed window)
- Window: 1 minute
- Limit: 60 requests/window
- Queue: 0 (no queuing â€” exceed â†’ 429 immediately)
- Applied at endpoint group level via `RequireRateLimiting("portfolio")`.

---

## 8. Error Handling

### GlobalExceptionMiddleware

All unhandled exceptions are caught here and serialized as `application/problem+json`.

| Exception Type | HTTP Status | `detail` Revealed |
|----------------|-------------|------------------|
| `ArgumentException` | 400 | Yes (always) |
| `UnauthorizedAccessException` | 401 | Yes |
| `KeyNotFoundException` | 404 | Yes |
| `InvalidOperationException` + "not found" in message | 404 | Yes |
| Any other | 500 | Development only |

Response shape (RFC 7807 inspired):
```json
{
  "type": "https://httpstatuses.com/400",
  "title": "Bad Request",
  "status": 400,
  "detail": "Name must not be null or empty."
}
```

`detail` is omitted in Production for 500-class errors.

### Endpoint-Level Catch Blocks

Several endpoints also have local try/catch blocks that return `Results.BadRequest` or `Results.NotFound` directly (before the middleware catches it). This creates a **dual-layer** error handling pattern â€” the middleware acts as a safety net for anything that escapes endpoint-level handling.

---

## 9. Hardening Controls

| Control | Configuration | Applied To |
|---------|---------------|-----------|
| Rate limiting | 60 req/min fixed window | `GET /api/portfolio/{slug}/projects` |
| Request body limit | 60 MB (Kestrel + FormOptions) | All endpoints |
| Image size guardrail | 10 MB | `AssetOrchestrator` (application layer) |
| Video size guardrail | 50 MB | `AssetOrchestrator` (application layer) |
| JWT validation | Issuer + Audience + Lifetime + SigningKey | All `RequireAuthorization()` endpoints |
| OwnerId isolation | Derived from JWT claim only | All project/asset mutations |
| Pinned project uniqueness | DB-level filtered unique index | `projects` table |

---

## 10. Known Risks & Edge Cases

| # | Risk | Severity | Detail |
|---|------|----------|--------|
| 1 | **Cloudinary orphan on deletion failure** | Medium | `DeleteAssetBothAsync` swallows Cloudinary deletion errors after DB commit. Orphaned Cloudinary files may accumulate silently. There is no reconciliation job. |
| 2 | **No migration files committed** | High | EF Core migration history is absent from the repo. Running `database update` against an already-migrated Render DB without an existing snapshot will fail. |
| 3 | **JWT Key is too short** | High | `Z8H8A61RWmAIg72ITOuUSSxmxh0YxgEGS6pue6Y5` is 41 chars â€” marginally acceptable but should be replaced with a 64+ char random key in production. The key must not be committed to version control. |
| 4 | **Slug collision on registration** | Low | If two concurrent registrations use the same slug, the unique index will reject the second at DB level with a `DbUpdateException` not currently mapped in `GlobalExceptionMiddleware` â†’ will surface as 500. |
| 5 | **No health check endpoint** | Low | There is no `/health` endpoint. Render and other orchestrators cannot perform live health probing. |
| 6 | **No structured logging or log aggregation** | Medium | `ILogger` is used only in the middleware's catch-all path. Cloudinary failures are noted with comments but not logged. No Sentry/Seq/etc. integration. |
| 7 | **No automated tests** | High | Zero unit, integration, or contract tests exist in the repository. |
| 8 | **Display order race condition** | Low | `ShiftDisplayOrders` + `NormalizeDisplayOrders` are not atomic with respect to concurrent requests from the same owner. Concurrent updates could produce duplicate display orders before normalization. The unique index on `(OwnerId, DisplayOrder)` will catch this and throw, but the UX is poor. |
| 9 | **Admin project list (`/api/projects/admin`) returns asset IDs but not URLs** | Low | `GetProjectsForAdminAsync` uses `MapToDto(project, null, null)` â€” `CoverUrl` and `DemoVideoUrl` are always `null` in the admin list response. This may surprise consumers. |
| 10 | **Token revocation not supported** | Low | JWTs are stateless. A compromised token remains valid for 7 days with no revocation mechanism. |

---

## 11. Improvement Candidates

### ðŸ”´ High Priority (Before Production)

| Item | Rationale |
|------|-----------|
| **Generate and commit EF Core migration baseline** | No migration files exist. The DB schema must be reproducible from scratch via `dotnet ef migrations add Initial`. |
| **Replace JWT Key with a 64+ char secret; store in environment only** | Current key is short and was committed to `appsettings.json`. Rotate immediately. |
| **Add integration tests for core flows** | Authentication, project CRUD, and public portfolio endpoint are untested. At minimum, use `WebApplicationFactory<Program>`. |
| **Map `DbUpdateException` in GlobalExceptionMiddleware** | Slug collision (concurrent register) currently returns 500. Map it to 409 Conflict with a user-friendly message. |
| **Add `/health` endpoint** | Required for Render health probing and zero-downtime deploys. A simple `app.MapGet("/health", () => Results.Ok())` suffices. |
| **Add structured logging** | Use `ILogger<T>` throughout services. Log Cloudinary failures, slug conflicts, token validation failures, and asset orphan scenarios. |

### ðŸŸ¡ Medium Priority (Next Iterations)

| Item | Rationale |
|------|-----------|
| **Return asset URLs in admin project list** | `GetProjectsForAdminAsync` should bulk-fetch and resolve `CoverUrl`/`DemoVideoUrl` similarly to `GetPublishedProjectsAsync`. |
| **Cloudinary orphan reconciliation** | A background job or admin command to compare DB assets vs. Cloudinary storage and clean up orphans. |
| **CI/CD pipeline** | Add GitHub Actions: restore â†’ build â†’ test â†’ push Docker image on merge to `main`/`develop`. |
| **Rate limiting on auth endpoints** | `POST /api/auth/login` has no rate limiting. A brute-force attack on passwords is currently unconstrained. |
| **Idempotent slug assignment** | Allow users to update their `PortfolioSlug` via `PUT /api/me/portfolio-slug` (endpoint exists in SETUP but not implemented). |
| **Pagination on project lists** | `GetProjectsForAdminAsync` and `GetPublishedProjectsAsync` return all records. This will become a performance issue at scale. |

### ðŸŸ¢ Nice to Have

| Item | Rationale |
|------|-----------|
| **OpenAPI / Swagger enrichment** | Add XML doc comments and `[ProducesResponseType]` attributes for accurate Swagger documentation. |
| **Refresh token support** | 7-day static expiry is coarse. Refresh tokens would improve security posture without hurting UX. |
| **Technology icon/logo URL** | The `Technology` entity has no image field. A logo URL would enrich the public portfolio display. |
| **Soft delete for projects** | Currently projects are hard-deleted. A soft-delete mechanism preserves history and makes rollback possible. |
| **Per-tenant rate limiting** | Current rate limiting is global on the portfolio route. Per-slug limiting would be fairer and harder to abuse. |
